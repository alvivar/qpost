<!DOCTYPE html>
<html>

<head>
    <title>Qpost</title>

    <script type='text/javascript' src='/eel.js'></script>
    <script src="/js/react.production.min.js"></script>
    <script src="/js/react-dom.production.min.js"></script>
    <script src="/js/babel.min.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/bulma.min.css" />
    <link rel="shortcut icon" type="image/png" href="/img/favicon.ico" />
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">

        class PathInput extends React.Component {

            constructor(props) {
                super(props);

                this.scanOnKeyDown = this.scanOnKeyDown.bind(this);
            }


            scanOnKeyDown(e) {
                // Enter
                if((e.keyCode == 10 || e.keyCode == 13)) {
                    this.props.scanPath(e);
                }
            }


            render() {
                const buttonClass = this.props.error ? 'button is-danger' : 'button is-primary';
                const buttonText = this.props.error ? this.props.error : 'Scan';

                return (
                    <section className="hero is-fullheight">
                        <div className="hero-body">
                            <div className="container">
                                <nav className="level">
                                    <div className="level-item">
                                        <input
                                            autoFocus className="input" type="text" placeholder="Paste your path here and click 'Scan'"
                                            value={this.props.path} onChange={this.props.updatePath} onKeyDown={this.scanOnKeyDown} />
                                        <a className={buttonClass} onClick={this.props.scanPath}>{buttonText}</a>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </section>
                );
            }
        }


        class Post extends React.Component {

            constructor(props) {
                super(props);

                this.state = {
                    editMode : false,
                    value : ""
                };

                this.toggleEditMode = this.toggleEditMode.bind(this);
                this.updateValueOnChange = this.updateValueOnChange.bind(this);
                this.saveData = this.saveData.bind(this);
                this.saveOnKeyDown = this.saveOnKeyDown.bind(this);
            }


            componentWillReceiveProps(nextProps) {
                if (this.state.value !== nextProps.value) {
                    this.setState({value : nextProps.value});
                }
            }


            toggleEditMode() {
                this.setState({
                    editMode : !this.state.editMode
                });
            }

            updateValueOnChange(e) {
                this.setState({
                    value : e.target.value
                });
            }

            saveData() {
                let id = this.props.id;
                let value = this.state.value;
                let newData = this.props.data.map(
                    i => i.id == id ? { id : i.id, file : i.file, description : value } : i
                );

                this.props.updateData(newData);
                this.toggleEditMode();
            }

            saveOnKeyDown(e) {
                // Ctrl + Enter
                if((e.keyCode == 10 || e.keyCode == 13) && e.ctrlKey) {
                    this.saveData();
                }
            }


            renderShow() {
                return (
                    <div>
                        <span onClick={this.toggleEditMode}>
                            {this.state.value.trim() ? this.state.value : <p className="help">(Click to edit)</p>}
                        </span>
                    </div>
                );
            }

            renderEdit() {
                return (
                    <div>
                        <textarea autoFocus
                            className="textarea" value={this.state.value}
                            onChange={this.updateValueOnChange} onKeyDown={this.saveOnKeyDown}>
                        </textarea>
                        <br />
                        <a className="button is-primary" onClick={this.saveData}>Save</a>
                    </div>
                );
            }

            render() {
                if (!this.state.editMode) {
                    return this.renderShow();
                }
                else {
                    return this.renderEdit();
                }
            }
        }


        class PostsCollection extends React.Component {

            constructor(props) {
                super(props);

                this.moveUp = this.moveUp.bind(this);
                this.moveDown = this.moveDown.bind(this);
            }


            moveUp(id, e) {
                // Find
                let idIndex = this.props.data.findIndex(
                    i => i.id == id
                );

                // Move
                let newData = this.props.data;
                let value = newData[idIndex];

                newData.splice(idIndex, 1);  // Remove
                idIndex = idIndex > 0 ? idIndex - 1 : 0;  // Up
                newData.splice(idIndex, 0, value);  // Insert

                this.props.updateData(newData);
            }

            moveDown(id, e) {
                // Find
                let idIndex = this.props.data.findIndex(
                    i => i.id == id
                );

                // Move
                let newData = this.props.data;
                let value = newData[idIndex];

                newData.splice(idIndex, 1);  // Remove
                idIndex = idIndex + 1;  // Down
                newData.splice(idIndex, 0, value);  // Insert

                this.props.updateData(newData);
            }


            render() {
                const posts = this.props.data.map((data) =>
                    <div className="">
                        <div className="card">
                            <div className="card-image">
                                <figure className="image">
                                    <img src={data.file} />
                                </figure>
                            </div>
                            <div className="card-content">
                                <div className="content">
                                    <Post id={data.id} value={data.description} data={this.props.data} updateData={this.props.updateData} />
                                </div>
                            </div>
                            <footer className="card-footer">
                                <a onClick={e => this.moveUp(data.id, e)} className="button card-footer-item">Up</a>
                                <a onClick={e => this.moveDown(data.id, e)} className="button card-footer-item">Down</a>
                            </footer>
                        </div>
                        <hr />
                    </div>
                );

                return (
                    <section className="section">
                        <div className="container">
                            <nav className="level navbar is-fixed-top">
                                <div className="level-item">
                                    <a className="button" onClick={this.props.clearPath}>Back</a>
                                    <a className="button is-primary" onClick={this.props.clearPath}>Save</a>
                                </div>
                            </nav>
                            <br />
                            <div className="">
                                {posts}
                            </div>
                        </div>
                    </section>
                );
            }
        }


        class Main extends React.Component {

            constructor(props) {
                super(props);

                this.state = {
                    hasPath : false,
                    hasError : false,
                    path : '',
                    data : []
                };

                this.updatePathOnChange = this.updatePathOnChange.bind(this);
                this.scanPathOnClick = this.scanPathOnClick.bind(this);
                this.clearPathOnClick = this.clearPathOnClick.bind(this);
                this.updateData = this.updateData.bind(this);
            }


            updatePathOnChange(e) {
                this.setState({
                    path : e.target.value
                });
            }

            async scanPathOnClick(e) {

                // Scan the path for files
                let allow = ['*.gif', '*.jpg', '*.png']  // Only images
                let files = await eel.get_files_dirs(this.state.path, allow)();
                files = files[0];  // First element from the tuple result are the files, seconds dirs

                if (files.length > 0)
                {
                    // We need to copy the files in the app folder to render
                    // them because of chrome safety rules :/
                    let localPath = await eel.copytree(this.state.path, allow)();
                    let localFiles = await eel.get_files_dirs(localPath, allow)();
                    localFiles = localFiles[0];
                    localFiles = localFiles.map(x => x.split('\\eeldata').pop());  //  ... \cache |cut| = app base

                    // Create a data node for each file
                    let newData = localFiles.map(async (i) => ({
                        id : await eel.flatname(i)(),
                        file : i,
                        description : ""
                    }));

                    await Promise.all(newData).then(promisedData => {
                        newData = promisedData;

                        this.setState({
                            hasPath : true,
                            hasError : false,
                            data : newData
                        })
                    });

                    await eel.savefile(this.state.path, newData)();
                }
                else {
                    this.setState({
                        hasError : "No files found!"
                    });

                    setTimeout(function() {
                        this.setState({
                            hasError : false
                        });
                    }.bind(this), 2000);
                }
            }

            clearPathOnClick(e) {
                this.setState({
                    hasPath : false
                });
            }

            async updateData(newData) {
                this.setState({
                    data : newData
                });

                await eel.savefile(this.state.path, newData)();
                console.log(newData);
            }


            renderPathInput() {
                return (
                    <PathInput
                        path={this.state.path}
                        updatePath={this.updatePathOnChange}
                        scanPath={this.scanPathOnClick}
                        error={this.state.hasError} />
                );
            }

            renderPosts() {
                return (
                    <PostsCollection
                        data={this.state.data}
                        updateData={this.updateData}
                        clearPath={this.clearPathOnClick} />
                );
            }

            render() {
                if (this.state.hasPath) {
                    return this.renderPosts();
                }
                else {
                    return this.renderPathInput();
                }
            }
        }


        ReactDOM.render(
            <Main />,
            document.getElementById('root')
        );

    </script>
</body>

</html>