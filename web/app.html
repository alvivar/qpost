<!DOCTYPE html>
<html>

<head>
    <title>Qpost</title>

    <script type='text/javascript' src='/eel.js'></script>
    <script src="/js/react.production.min.js"></script>
    <script src="/js/react-dom.production.min.js"></script>
    <script src="/js/babel.min.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/bulma.min.css" />
    <link rel="shortcut icon" type="image/png" href="/img/favicon.ico" />
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">

        class PathInput extends React.Component {
            render() {
                const buttonClass = this.props.error ? 'button is-danger' : 'button is-primary';
                const buttonText = this.props.error ? this.props.error : 'Scan';

                return (
                    <section className="hero is-fullheight">
                        <div className="hero-body">
                            <div className="container">
                                <nav className="level">
                                    <div className="level-item">
                                        <input className="input" value={this.props.path} onChange={this.props.updatePath} type="text" placeholder="Paste your path here and click 'Scan'" />
                                        <button className={buttonClass} onClick={this.props.scanPath}>{buttonText}</button>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </section>
                );
            }
        }


        class Post extends React.Component {
            render() {
                return (
                   <span>
                        {this.props.name}
                   </span>
                );
            }
        }


        class PostsCollection extends React.Component {
            render() {
                const posts = this.props.files.map((file) =>
                    <article className="media">
                        <figure className="media-left">
                            {/*<p className="image is-64x64">
                                <img src="https://bulma.io/images/placeholders/128x128.png" />
                            </p>*/}
                        </figure>
                        <div className="media-content">
                            <div className="content">
                                <img src={file} />
                            </div>
                        </div>
                        <div className="media-right">
                            {/*<button className="delete"></button>*/}
                        </div>
                    </article>
                );

                return (
                    <section className="section">
                        <div className="container">
                            <nav className="level">
                                <div className="level-item">
                                    <button className="button" onClick={this.props.clearPath}>Back</button>
                                    <button className="button is-primary" onClick={this.props.clearPath}>Create</button>
                                </div>
                            </nav>
                            {posts}
                        </div>
                    </section>
                );
            }
        }


        class Main extends React.Component {

            constructor(props) {
                super(props);

                this.state = {
                    hasPath : false,
                    hasError : false,
                    waiting : false,
                    path : '',
                    files : []
                }

                this.updatePathOnChange = this.updatePathOnChange.bind(this);
                this.scanPathOnClick = this.scanPathOnClick.bind(this);
                this.clearPathOnClick = this.clearPathOnClick.bind(this);
            }


            updatePathOnChange(e) {
                this.setState({
                    path : e.target.value
                });
            }

            async scanPathOnClick(e) {
                let allow = ['*.gif', '*.jpg', '*.png']  // Only images
                let files = await eel.get_files_dirs(this.state.path, allow)();
                files = files[0];  // First element from the tuple are the files

                if (files.length > 0)
                {
                    this.setState({
                        waiting : true
                    });

                    let localPath = await eel.copytree(this.state.path, allow)();
                    let localFiles = await eel.get_files_dirs(localPath, allow)();

                    localFiles = localFiles[0];
                    localFiles = localFiles.map(function(x) {
                        return x.replace('\web', '');
                    });

                    this.setState({
                        hasPath : true,
                        hasError : false,
                        files : localFiles
                    });
                }
                else {
                    this.setState({
                        hasError : "No files found!"
                    });

                    setTimeout(function() {
                        this.setState({
                            hasError : false
                        });
                    }.bind(this), 2000);
                }
            }

            clearPathOnClick(e) {
                this.setState({
                    hasPath : false
                });
            }


            renderPathInput() {
                return (
                    <PathInput
                        path={this.state.path}
                        updatePath={this.updatePathOnChange}
                        scanPath={this.scanPathOnClick}
                        error={this.state.hasError} />
                );
            }

            renderPosts() {
                return (
                    <PostsCollection
                        files={this.state.files}
                        clearPath={this.clearPathOnClick} />
                );
            }

            render() {
                if (this.state.hasPath) {
                    return this.renderPosts();
                }
                else {
                    return this.renderPathInput();
                }
            }
        }


        ReactDOM.render(
            <Main />,
            document.getElementById('root')
        );

    </script>
</body>

</html>